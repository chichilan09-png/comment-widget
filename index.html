<!DOCTYPE html>
<html>
<body>
<div id="comments"></div>
<img src="https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar1.jpg" width="100">

<form id="commentForm">
<input id="name" placeholder="Tên của bạn" required><br>
<textarea id="comment" placeholder="Viết bình luận..." required></textarea><br>
<button type="submit">Gửi</button>
</form>

<script>
const API="https://script.google.com/macros/s/AKfycby_Q9yLCR4JLxYjn1vEYBeQJd6dWYv2xtg_dAKtkTV0YUo92DPxCxzH37Nk5k32Gxno/exec";
const PAGE=location.pathname;

const avatars=[
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar1.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar2.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar3.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar4.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar5.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar6.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar7.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar8.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar9.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar10.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar11.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar12.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar13.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar14.jpg",
 "https://raw.githubusercontent.com/chichilan09-png/comment-widget/main/Avatars/avatar15.jpg"
];

function randomAvatar(){
 return avatars[Math.floor(Math.random()*avatars.length)];
}

/* ===== LƯU COMMENT VÀO LOCAL STORAGE ===== */
function saveLocalComments(data){
 localStorage.setItem("comments_"+PAGE, JSON.stringify(data));
}

function loadLocalComments(){
 const cache = localStorage.getItem("comments_"+PAGE);
 return cache ? JSON.parse(cache) : [];
}

/* ===== LOAD COMMENT TỪ GOOGLE SHEETS ===== */
async function loadComments(){
 try{
  const res=await fetch(API+"?page="+PAGE);
  const data=await res.json();
  render(data);
  saveLocalComments(data); // lưu cache
 }catch(e){
  console.log("API lỗi, load comment cache");
  const old = loadLocalComments();
  render(old);
 }
}

/* ===== HIỂN THỊ COMMENT ===== */
function render(data){
 const box=document.getElementById("comments");
 box.innerHTML="";
 data.forEach(c=>{
  box.innerHTML+=`
   <div style="border:1px solid #ddd;padding:10px;margin:10px">
    <img src="${c.avatar}" width="40" style="border-radius:50%">
    <b>${c.name}</b><br>
    ${c.comment}
   </div>
  `;
 });
}

/* ===== GỬI COMMENT ===== */
document.getElementById("commentForm").onsubmit=async(e)=>{
 e.preventDefault();
 const newComment={
   page:PAGE,
   name:document.getElementById("name").value,
   avatar:randomAvatar(),
   comment:document.getElementById("comment").value
 };

 await fetch(API,{
  method:"POST",
  body:JSON.stringify(newComment)
 });

 // hiển thị ngay comment mới (không cần chờ API)
 const cache = loadLocalComments();
 cache.push(newComment);
 saveLocalComments(cache);
 render(cache);

 name.value=""; comment.value="";
};

/* LOAD CACHE TRƯỚC */
render(loadLocalComments());

/* LOAD SERVER MỖI 1 GIÂY */
setInterval(loadComments,1000);
loadComments();
</script>
</body>
</html>
